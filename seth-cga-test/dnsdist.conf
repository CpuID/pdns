-- -----------------------------------------------------------------------------------------------
-- dnsdist.conf
-- Seth Ornstein - sornstein@globalcyberalliance.org
-- 5/9/2017
-- checkout: https://github.com/PowerDNS/pdns/blob/master/pdns/dnsdistconf.lua
-- -----------------------------------------------------------------------------------------------


   warnlog(string.format("Script starting ----------------- %s ", os.date("%X-%x")))

   warnlog(string.format("Script starting ----------------- Lua Version: %s  - (should be 5.1)", _VERSION))


   strCPackage = "lua-tinycdb-0.2-modified-Makefile"        -- where cdb library is located
   strLibrary  = "cdb"                                      -- the name of the tinycdb library
   strDatabase = "../../seth-cga-test/CDB_Database/blocklist.cdb"		    -- location of cdb database
   strTestDns1 = "1jw2mr4fmky.net"                          -- test #1 dns lookup name
   strTestDns2 = "google.com"                               -- test #2 dns lookup name

   maintCounter = 0                                         -- maintainance counter

-- -----------------------------------------------------------------------------------------------
-- -----------------------------------------------------------------------------------------------
-- tinycdb - 5/4/2017
-- -----------------------------------------------------------------------------------------------


   warnlog(string.format("Script starting ----------------- *** C package path addition.: %s ***", strCPackage))
 
   package.cpath = package.cpath .. ';' .. strCPackage .. '/?.so'

   warnlog(string.format("Script starting ----------------- *** Load lua-tinycdb library: %s ***", strLibrary))

   cdb = require(strLibrary)      

   warnlog(string.format("Script starting ----------------- *** Load RPZ cdb database...: %s ***", strDatabase))

   db = cdb.open(strDatabase)

   if (db == nil)
   then
       warnlog(string.format("Script starting ----------------- *** COULD NOT LOAD DB.......: %s ***", strDatabase))
   end

   local tValue = db:get(strTestDns1)            -- "search for test key, return test value"
   if(tValue == nil)
   then
   	warnlog(string.format("Script starting ----------------- *** Test RPZ   Key: %s   Value: nil ***   ", strTestDns1))
   else
   	warnlog(string.format("Script starting ----------------- *** Test RPZ   Key: %s   Value: %s   Len: %d  ***", strTestDns1, tValue, string.len(tValue)))
   end

   local tValue2 = db:get(strTestDns2)                       -- "search for test key, return test value"
   if(tValue2 == nil)
   then
  	warnlog(string.format("Script starting ----------------- *** Test RPZ   Key: %s   Value: nil ***", strTestDns2))
   else
  	warnlog(string.format("Script starting ----------------- *** Test RPZ   Key: %s   Value: %s   Len: %d ***", strTestDns2, tValue2, string.len(tValue2)))
   end
 
   local iBlackListCount = 0
   for k, v in db:pairs() do
      iBlackListCount = iBlackListCount + 1
   end
   warnlog(string.format("Script starting ----------------- *** RPZ entries: %d ***", iBlackListCount))

-- -----------------------------------------------------------------------------------------------
-- -----------------------------------------------------------------------------------------------

-- -----------------------------------------------------------------------------------------------
-- setup servers to use
   warnlog(string.format("Script starting ----------------- %s ", "*** setup servers to use ***"))
-- -----------------------------------------------------------------------------------------------

--newServer({address="149.112.112.112:53", name="Gca_1", pool="masterpool"})            -- gca dns server #1
--newServer({address="149.112.149.112:53", name="Gca_2", pool="masterpool"})            -- gca dns server #2
--newServer({address="64.6.64.6:53",       name="Verisign_1", pool="masterpool"})       -- verisign dns server #1
--newServer({address="64.6.65.6:53",       name="Verisign_2", pool="masterpool"})       -- verisign dns server #2
newServer({address="8.8.8.8:53",         name="Google_1", pool="masterpool"})         -- google dns server #1
newServer({address="8.8.4.4:53",         name="Google_2", pool="masterpool"})         -- google dns server #2
--newServer({address="208.67.222.222:53",  name="Opendns_1", pool="masterpool"})        -- opendns dns server #1
--newServer({address="208.67.220.220:53",  name="Opendns_2", pool="masterpool"})        -- opendns dns server #2


-- -----------------------------------------------------------------------------------------------
-- set up the cache 
-- 10000 ->  maximum number of entries stored in the cache (required)
-- 86400 ->  maximum lifetime of an entry in the cache (seconds)
--     0 ->  minimum TTL an entry should have to be considered for insertion in the cache (seconds)
--    60 ->  TTL used for a Server Failure or a Refused response (seconds)
--    60 ->  TTL that will be used when a stale cache entry is returned (seconds)
   warnlog(string.format("Script starting ----------------- %s ", "*** setup cache *** "))
-- -----------------------------------------------------------------------------------------------

   pc = newPacketCache(10000, 86400, 0, 60, 60)         -- new cache
   getPool("masterpool"):setCache(pc)                   -- masterpool cache


   setStaleCacheEntriesTTL(3600)			-- If no backends working, use cached data

-- -----------------------------------------------------------------------------------------------
-- maintenance() function called every second

   function maintenance()

   if ((maintCounter % 30) == 0) then
       print(string.format("\n    maintenance() - %s", os.date("%X-%x")))
--[[
       local tablePoolServers = getPoolServers("masterpool")

       for k, v in pairs( tablePoolServers ) do
           print(string.format("    maint-#1() -> poolServer: %s    Name: %s   Adr: %s", k, v:getName(), v:getNameWithAddr()))
       end

       local tableServers = getServers()
       for k, v in pairs( tableServers ) do
           print(string.format("    maint-#2() -> Server....: %s    Name: %s   Adr: %s", k, v:getName(), v:getNameWithAddr()))
       end
--]]
       local tableStat = getStatisticsCounters()
       for k, v in pairs( tableStat ) do
           print(string.format("       %-23s  %d ", k, v))
       end
   end
   maintCounter = maintCounter + 1
   end

-- -----------------------------------------------------------------------------------------------
-- luaCheckBL() - check blacklist using lua-tinydns - 5/5/2017
-- if in blacklist then spoof response
-- else forward normally to masterpool 
   warnlog(string.format("Script starting ----------------- %s ", "*** luaForwardLookup() *** "))
-- -----------------------------------------------------------------------------------------------

    function luaCheckBL(dq)
        print(string.format("luaCheckBL -> qname.: %s ", dq.qname:toString()))

--        print(string.format("luaCheckBL -> qtype.: %d ", dq.qtype))
--        print(string.format("luaCheckBL -> from..: %s ", dq.remoteaddr:toStringWithPort()))
--        print(string.format("luaCheckBL -> opcode: %d ", dq.opcode))
--        print(string.format("luaCheckBL -> rcode.: %d ", dq.rcode))
--        print(string.format("luaCheckBL -> qclass: %d ", dq.qclass))
--        print(string.format("luaCheckBL -> DO....: %s ", tostring(dq:getDO())))
--	  print(string.format("luaCheckBL -> Len...: %d ", dq.len))	 
--	  print(string.format("luaCheckBL -> Size..: %d ", dq.size))	 
--	  print(string.format("luaCheckBL -> TCP...: %s ", tostring(dq.tcp)))


	local tKey   = dq.qname:toString()
	if(tKey ~= nil)
     	then
		local tKey2  = string.sub(tKey, 1, string.len(tKey) - 1)		-- get rid of final period
--		print(string.format("luaCheckBL -> tKey2.: %s ", tKey2))
   		local tValue = db:get(tKey2) 			-- search for key, return string or nil if not found
		if(tValue ~= nil) 
		then
                        dq:setExtraXXX(tValue)                  -- store blacklist extra data in dq for protobuf later -- NEW LUA COMMAND

                        dq:setTagXXX("RPZ", tValue)		-- store blacklist extra data in dq for protobuf later -- NEW LUA COMMAND - 5/22/2017
                        dq:setTagXXX("lua-time", os.date("%X-%x"))   -- store blacklist extra data in dq for protobuf later -- NEW LUA COMMAND - 5/22/2017
                        dq:setTagXXX("lua-ver", _VERSION)            -- store blacklist extra data in dq for protobuf later -- NEW LUA COMMAND - 5/22/2017
                        dq:setTagXXX("From", dq.remoteaddr:toStringWithPort())  -- store blacklist extra data in dq for protobuf later -- NEW LUA COMMAND - 5/22/2017
                        dq:setTagXXX("TCP", tostring(dq.tcp))                   -- store blacklist extra data in dq for protobuf later -- NEW LUA COMMAND - 5/22/2017

        		print(string.format("luaCheckBL -> RpzHit: %s   **********", tValue))

  			print(string.format("--"))

			return DNSAction.None, ""		-- continue to the next rule

		end
	end

        print(string.format("luaCheckBL -> return DNSAction.Pool to masterpool "))
  	print(string.format("--"))
	return DNSAction.Pool, "masterpool"		-- use the specified pool to forward this query

    end



-- -----------------------------------------------------------------------------------------------
-- listen on local port 5200
   warnlog(string.format("Script starting ----------------- %s ", "*** listen on port 0.0.0.0:5200 for DNS requests ***"))
-- -----------------------------------------------------------------------------------------------

   setLocal("0.0.0.0:5200")



-- -----------------------------------------------------------------------------------------------
-- declare a Lua action function to alter the protobuf when a normal forwarding happens
   warnlog(string.format("Script starting ----------------- %s ", "*** luaLogForward() ->  127.0.0.1:60000 ***"))
-- -----------------------------------------------------------------------------------------------

function luaLogForward(dr, pbMsg)
   print(string.format("luaLogForward -> qname: %s   qtype: %d   from: %s   TCP: %s ", dr.qname:toString(), dr.qtype, dr.remoteaddr:toStringWithPort(), tostring(dr.tcp)))

--   print(string.format("luaLogForward -> opcode: %d ", dr.opcode))
--   print(string.format("luaLogForward -> rcode.: %d ", dr.rcode))
--   print(string.format("luaLogForward -> qclass: %d ", dr.qclass))
--   print(string.format("luaLogForward -> len...: %d ", dr.len))
--   print(string.format("luaLogForward -> pb: %s ", pbMsg:toDebugString()))  -- output debug string

--   pbMsg:setExtraValXXX(3)			-- mark as forward, ie. normal lookup on dns servers -- NEW LUA COMMAND

--   pbMsg:setExtraValXXX(DNSRespMethXXX.Forward) -- mark as forward, ie. normal lookup on dns servers -- NEW LUA COMMAND

--   pbMsg:setAppliedPolicyXXX("FWD")   		-- set applied policy in protobuf log  to be forward -- NEW LUA COMMAND

   pbMsg:addTagsXXX("FWD")	                -- add tag field indicating forward transaction      -- NEW LUA COMMAND


   print(string.format("--"))
end


rlFwd = newRemoteLogger('127.0.0.1:60000')


-- -----------------------------------------------------------------------------------------------
-- declare a Lua action function to alter the protobuf when a Cache hit occurs
   warnlog(string.format("Script starting ----------------- %s ", "*** luaLogCache() ->  127.0.0.1:60000 ***"))
-- -----------------------------------------------------------------------------------------------

function luaLogCache(dr, pbMsg)		-- this is the lua code that executes after a cache hit
   print(string.format("luaLogCache -> qname: %s   qtype: %d   from: %s   TCP: %s ", dr.qname:toString(), dr.qtype, dr.remoteaddr:toStringWithPort(), tostring(dr.tcp)))

--   pbMsg:setExtraValXXX(2)			-- mark as cache -- NEW LUA COMMAND

--   pbMsg:setExtraValXXX(DNSRespMethXXX.Cache)	-- mark as cache -- NEW LUA COMMAND

--   pbMsg:setAppliedPolicyXXX("CACHE")           -- set applied policy in protobuf log  to be cache -- NEW LUA COMMAND

   pbMsg:addTagsXXX("CACHE")	                -- add tag indicating cache transaction            -- NEW LUA COMMAND


   print(string.format("--"))
end

rlCache = newRemoteLogger('127.0.0.1:60000')


-- -----------------------------------------------------------------------------------------------
-- declare a Lua action functino to alter the protobuf when a BlackList (RPZ) hit occurs
   warnlog(string.format("Script starting ----------------- %s ", "*** luaLogBL() ->  127.0.0.1:60000 ***"))
-- -----------------------------------------------------------------------------------------------

function luaLogBL(dr, pbMsg)		-- this is the lua code that executes for a request
   print(string.format("luaLogBL -> qname: %s   qtype: %d   from: %s   TCP: %s ", dr.qname:toString(), dr.qtype, dr.remoteaddr:toStringWithPort(), tostring(dr.tcp)))
--   print(string.format("luaLogBL -> pb: %s ", pbMsg:toDebugString()))  -- output debug string

--   pbMsg:setExtraMsgXXX("The quick brown fox.") -- this is a test of the new extra message field

   print(string.format("LuaLogBL -> calling getExtraXXX()"))

   local strRpzInfo = dr:getExtraXXX()	          -- get the stored blacklist value  -- NEW LUA COMMAND

   print(string.format("luaLogBL -> ExtraXXX: %s ", strRpzInfo))

   pbMsg:setExtraMsgXXX(strRpzInfo)               -- set the source of the blacklist value to go out via protobuf  -- NEW LUA COMMAND


   local strRpzInfo     = dr:getTagMatchXXX("RPZ")	          -- get the stored blacklist value  -- NEW LUA COMMAND - 5/22/2017
   local strLuaTimeInfo = dr:getTagMatchXXX("lua-time")	  -- get the stored blacklist value  -- NEW LUA COMMAND - 5/22/2017
   local strLuaVerInfo  = dr:getTagMatchXXX("lua-ver")	  -- get the stored blacklist value  -- NEW LUA COMMAND - 5/22/2017
   local strFromInfo    = dr:getTagMatchXXX("From")	          -- get the stored blacklist value  -- NEW LUA COMMAND - 5/22/2017
   local strTcpInfo     = dr:getTagMatchXXX("TCP")	          -- get the stored blacklist value  -- NEW LUA COMMAND - 5/22/2017

   local iEntries       = dr:getTagCountXXX()                   -- get the number of tag entries   -- NEW LUA COMMAND - 5/23/2017


   print(string.format("luaLogBL -> getTagMatchXXX - RPZ....: %s ", strRpzInfo))
   print(string.format("luaLogBL -> getTagMatchXXX - LuaTime: %s ", strLuaTimeInfo))
   print(string.format("luaLogBL -> getTagMatchXXX - LuaVer.: %s ", strLuaVerInfo))
   print(string.format("luaLogBL -> getTagMatchXXX - From...: %s ", strFromInfo))
   print(string.format("luaLogBL -> getTagMatchXXX - TCP....: %s ", strTcpInfo))
   
   print(string.format("luaLogBL -> getTagCountXXX - Count..: %d ", iEntries))

   print(string.format("luaLogBL -> debug: %s ", dr:getTagDebugStringXXX()))  -- output debug string -- NEW LUA COMMAND - 5/23/2017

   print(string.format("luaLogBL -> list all the tags: "))
   for ii=1, iEntries, 1 do
       print(string.format("\t Entry: %d   Tag: %s ", ii, dr:getTagEntryXXX(ii)))
   end



   print(string.format("luaLogBL -> dr:getTagArrayXXX() "))                     
   local tableTags = dr:getTagArrayXXX()			-- get array of tags inserted by setTagXXX() - NEW LUA COMMAND - 5/24/2017
   for k, v in pairs( tableTags ) do
           print(string.format("\t Label: %-15s   Value: %s ", k, v))
       end

   print(string.format("luaLogBL-> Test adding to table tableTags"))
   tableTags["dude1"] = "test1"					-- test adding entry to tags
   tableTags["dude2"] = "test2"					-- test adding entry to tags
   tableTags["dude3"] = "test3"					-- test adding entry to tags
   tableTags["dude4"] = "test4"					-- test adding entry to tags

   print(string.format("luaLogBL-> setTagArrayXXX(tableTags)"))

    pbMsg:setTagArrayXXX(tableTags)				-- set array of tags - NEW LUA COMMAND - 5/24/2017



--   print(string.format("luaLogBL -> dnsdist.ANY    = %d ", dnsdist.ANY))
--   print(string.format("luaLogBL -> dnsdist.NOTIMP = %d ", dnsdist.NOTIMP))
--   print(string.format("luaLogBL -> dnsdist.NAPTR  = %d ", dnsdist.NAPTR))
--   print(string.format("luaLogBL -> dnsdist.BLACKLIST = %d ", dnsdist.BLACKLIST))
 
   print(string.format("luaLogBL -> DNSRespMethXXX.Blacklist = %d ", DNSRespMethXXX.Blacklist))

--   pbMsg:setExtraValXXX(DNSRespMethXXX.Blacklist)	  -- mark as blacklist -- NEW LUA COMMAND

--   pbMsg:setAppliedPolicyXXX("BLKLST")            -- set applied policy in protobuf log  to be cache -- NEW LUA COMMAND


--   pbMsg:setExtraFieldsXXX("Test-1", 1, "One")    -- store some test values -- NEW LUA COMMAND
--   pbMsg:setExtraFieldsXXX("Test-2", 2, "Two")    -- store some test values -- NEW LUA COMMAND
--   pbMsg:setExtraFieldsXXX("Test-3", 3, "Three")  -- store some test values -- NEW LUA COMMAND

 
   pbMsg:setResponseCode(dnsdist.NXDOMAIN)        -- set protobuf response code to be NXDOMAIN

--   pbMsg:addTagsXXX("Test tag one")	  -- add tag
--   pbMsg:addTagsXXX("Test tag two")	  -- add another tag
--   pbMsg:addTagsXXX("Test tag three")	  -- add another tag

   strReqName = dr.qname:toString()		  -- get request dns name

   strExtraInfo = string.format("RPZ %s", strRpzInfo)

   pbMsg:setProtobufResponseTypeXXX(strReqName, strExtraInfo)   -- set protobuf to look like a response and not a query, insert query time -- NEW LUA COMMAND
                                                                -- strReqName - The DNS name that was sent by the client to be looked up.
                                                                -- strExtraInfo - type of hit (RPZ, CACHE, FWD, etc), followed by info obtained in rpz lookup.
                                                                --                this string is stored in the 'tags' field of the protobuf currently


   print(string.format("--"))
end

rlBlkLst = newRemoteLogger('127.0.0.1:60000')



-- ----------------------------------------------------------------------------------------------
								-- put this here so blacklist sends out protobuf......
function luaRetNXDOMAIN(dq)
	print(string.format("luaRetNXDOMAIN() - return NXDOMAIN to client"))
        print(string.format("--"))
	return DNSAction.Nxdomain, ""		-- return NXDOMAIN response to client
end


-- -----------------------------------------------------------------------------------------------
-- Rules
   warnlog(string.format("Script starting ----------------- %s ", "*** setting rules *** "))
-- -----------------------------------------------------------------------------------------------


   addLuaAction(AllRule(), luaCheckBL)		              -- first, check blacklist, if match process next rule below, else send to "masterpool"


   addAction(AllRule(), RemoteLogAction(rlBlkLst, luaLogBL))  -- then send out protobuf for rpz hit 


   addLuaAction(AllRule(), luaRetNXDOMAIN)		      -- then send nxdomain response back to the client.


   addAction(AllRule(), PoolAction("masterpool"))	      -- direct requests that are not RPZ to pool "masterpool"		

   addCacheHitResponseAction(AllRule(), RemoteLogResponseAction(rlCache, luaLogCache))	-- used to send out protobuf on cache hit 

   addResponseAction(AllRule(), RemoteLogResponseAction(rlFwd, luaLogForward))		-- used to send out protobuf on forward (normal) out 

-- -----------------------------------------------------------------------------------------------
-- finished
-- -----------------------------------------------------------------------------------------------

   warnlog(string.format("Script finished ----------------- %s ", os.date("%X-%x")))

